 /***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      basic_serial.hpp
 * 
 * @version   1.0
 *
 * @date      19-02-2025
 *
 * @brief     Prototype of functions and object, providing control, local settings, input, and output for serial ports on Linux, library developed for interacting with embedded systems in mind (non-cannonical).  
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 *            https://man7.org/linux/man-pages/man2/TIOCMSET.2const.html , 
 *            https://people.na.infn.it/~garufi/didattica/CorsoAcq/SerialProgrammingInPosixOSs.pdf
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Definition file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#ifndef BASIC_SERIAL_HPP
#define BASIC_SERIAL_HPP

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Imported libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <stdio.h>    
#include <stdlib.h>    
#include <string.h>  
#include <stdint.h>
#include <stdbool.h>
#include <stdarg.h>
#include <termios.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h> 
#include <sys/ioctl.h>
#include <linux/limits.h>

#include <stdexcept>
#include <memory>

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Objects
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

namespace 
serial_port {
  class
  SerialPort {
    private:
      typedef enum class
      FlowControl : uint8_t {
        None,
        Hardware,
        Software,
      };
    
      typedef enum class 
      Parity : uint8_t {
        None,
        Odd,
        Even,
      };
    
      typedef enum class
      DataBits : uint8_t {
        Five = 5,
        Six = 6,
        Seven = 7,
        Eight = 8,
      };
    
      typedef enum class
      StopBits : uint8_t {
        One = 1,
        Two = 2,
      };
    
      typedef enum class
      Line {
        DSR = TIOCM_LE,
        DTR = TIOCM_DTR,
        RTS = TIOCM_RTS,
        CTS = TIOCM_CTS,
        DCD = TIOCM_CAR,
      };
    
      struct 
      Configuration{
        bool        readonly   = false;                                        //!< If the file pointer will be given in read only mode, example NO = r+.
        int         baudrate   = B9600;                                        //!< The baud rate of the communication in bits per second, example B9600.
        FlowControl flow       = FlowControl::None;                            //!< The hardware flow control, example Hardware.
        Parity      parity     = Parity::None;                                 //!< The detection of error parity, example Odd.
        DataBits    bData      = DataBits::Eight;                              //!< The number of bits per serial word, example 8.
        StopBits    bStop      = StopBits::One;                                //!< The number of stop bits per serial word, example 1.
        uint16_t    timeout    = 1;                                            //!< The time any read function will wait in deciseconds for the information to arrive, example 200.
        uint16_t    minBytes   = 0;                                            //!< The minimum number of bytes to necessary receive before returning the read function.
      };
  
    protected:
      Configuration                                config;                     //!< The confifguration of the serial port object.
      std::unique_ptr <FILE, decltype( &fclose )>  fp;                         //!< The file descriptor for the serial port opened.
      std::unique_ptr <int, decltype( &close )>    fd;                         //!< The file pointer for the serial port opened.
      std::string                                  pathname;                   //!< The path to the serial port device in Linux file system, example "/dev/ttyUSB0"

    public:
      SerialPort( const std::string& _pathname );
      ~SerialPort( void );  
  };
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Definition file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#endif

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End of file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/